const fs = require("fs");
const path = require("path");

function ensureAddress(address) {
  if (typeof address !== "string" || !address.startsWith("0x") || address.length !== 42) {
    throw new Error(`Invalid address in deployment file: ${String(address)}`);
  }
}

function main() {
  const root = path.join(__dirname, "..");
  const deploymentPath = path.join(root, "deployments", "sepolia", "SafeHavenDocs.json");
  const frontendContractsPath = path.join(root, "frontend", "src", "config", "contracts.ts");

  if (!fs.existsSync(deploymentPath)) {
    throw new Error(`Missing deployment file: ${deploymentPath}. Deploy first with 'npm run deploy:sepolia'.`);
  }

  const deployment = JSON.parse(fs.readFileSync(deploymentPath, "utf8"));
  ensureAddress(deployment.address);

  const abiString = JSON.stringify(deployment.abi, null, 2);

  const content =
    `// This file is generated by scripts/sync-frontend-contracts.cjs\n` +
    `// Source: deployments/sepolia/SafeHavenDocs.json\n\n` +
    `export const SAFE_HAVEN_DOCS_ADDRESS = "${deployment.address}" as const;\n\n` +
    `export const SAFE_HAVEN_DOCS_ABI = ${abiString} as const;\n`;

  fs.mkdirSync(path.dirname(frontendContractsPath), { recursive: true });
  fs.writeFileSync(frontendContractsPath, content, "utf8");

  console.log(`Wrote ${frontendContractsPath}`);
}

main();

